<!doctype html><html lang=fr><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Graphe de temp√©rature et humidit√© avec un Raspberry Pi et un DHT22 | Blog de St√©phane</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="Le DHT22 est un petit capteur de temp√©rature et d&rsquo;humidit√©, facile d&rsquo;utilisation. On peut utiliser un Raspberry Pi pour interagir avec, et faire des graphes de l&rsquo;√©volution de la temp√©rature et de l&rsquo;humidit√©.
Mat√©riel Nous allons utiliser :
un Raspberry Pi (ici, la version 3B+) une carte SD de bonne qualit√© (classe 10) une alimentation fournissant du 5 V et du 2.5 √† 3 A un capteur d&rsquo;humidit√© et de temp√©rature DHT22 une r√©sistance de 10 k‚Ñ¶ une breadboard (bloc dans lequel on enfiche les composants √©lectroniques) un autre ordinateur pour se connecter au RPi en SSH un c√¢ble RJ45 Installation du RPi Pr√©paration de la carte SD Il est possible d&rsquo;installer sur un autre ordinateur le logiciel Raspberry Pi Imager qui permet de choisir la bonne version de l&rsquo;OS, la t√©l√©charger et l&rsquo;installer sur la carte SD."><meta name=generator content="Hugo 0.101.0"><meta name=ROBOTS content="INDEX, FOLLOW"><link rel=stylesheet href=/ananke/css/main.min.8ca51ad9680f6f5bb4adc9140a88775d0b6638471cd8aa5fc091c9e308bdacdd.css><meta property="og:title" content="Graphe de temp√©rature et humidit√© avec un Raspberry Pi et un DHT22"><meta property="og:description" content="Le DHT22 est un petit capteur de temp√©rature et d&rsquo;humidit√©, facile d&rsquo;utilisation. On peut utiliser un Raspberry Pi pour interagir avec, et faire des graphes de l&rsquo;√©volution de la temp√©rature et de l&rsquo;humidit√©.
Mat√©riel Nous allons utiliser :
un Raspberry Pi (ici, la version 3B+) une carte SD de bonne qualit√© (classe 10) une alimentation fournissant du 5 V et du 2.5 √† 3 A un capteur d&rsquo;humidit√© et de temp√©rature DHT22 une r√©sistance de 10 k‚Ñ¶ une breadboard (bloc dans lequel on enfiche les composants √©lectroniques) un autre ordinateur pour se connecter au RPi en SSH un c√¢ble RJ45 Installation du RPi Pr√©paration de la carte SD Il est possible d&rsquo;installer sur un autre ordinateur le logiciel Raspberry Pi Imager qui permet de choisir la bonne version de l&rsquo;OS, la t√©l√©charger et l&rsquo;installer sur la carte SD."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.deraco.fr/fr/post/2022-08-18-rpi-dht22/"><meta property="article:section" content="post"><meta property="article:published_time" content="2022-08-18T00:00:00+00:00"><meta property="article:modified_time" content="2022-08-18T00:00:00+00:00"><meta property="og:site_name" content="Blog de St√©phane"><meta itemprop=name content="Graphe de temp√©rature et humidit√© avec un Raspberry Pi et un DHT22"><meta itemprop=description content="Le DHT22 est un petit capteur de temp√©rature et d&rsquo;humidit√©, facile d&rsquo;utilisation. On peut utiliser un Raspberry Pi pour interagir avec, et faire des graphes de l&rsquo;√©volution de la temp√©rature et de l&rsquo;humidit√©.
Mat√©riel Nous allons utiliser :
un Raspberry Pi (ici, la version 3B+) une carte SD de bonne qualit√© (classe 10) une alimentation fournissant du 5 V et du 2.5 √† 3 A un capteur d&rsquo;humidit√© et de temp√©rature DHT22 une r√©sistance de 10 k‚Ñ¶ une breadboard (bloc dans lequel on enfiche les composants √©lectroniques) un autre ordinateur pour se connecter au RPi en SSH un c√¢ble RJ45 Installation du RPi Pr√©paration de la carte SD Il est possible d&rsquo;installer sur un autre ordinateur le logiciel Raspberry Pi Imager qui permet de choisir la bonne version de l&rsquo;OS, la t√©l√©charger et l&rsquo;installer sur la carte SD."><meta itemprop=datePublished content="2022-08-18T00:00:00+00:00"><meta itemprop=dateModified content="2022-08-18T00:00:00+00:00"><meta itemprop=wordCount content="1946"><meta itemprop=keywords content="Raspberry Pi,DHT22,Humidit√©,Temp√©rature,Grafana,Prometheus,"><meta name=twitter:card content="summary"><meta name=twitter:title content="Graphe de temp√©rature et humidit√© avec un Raspberry Pi et un DHT22"><meta name=twitter:description content="Le DHT22 est un petit capteur de temp√©rature et d&rsquo;humidit√©, facile d&rsquo;utilisation. On peut utiliser un Raspberry Pi pour interagir avec, et faire des graphes de l&rsquo;√©volution de la temp√©rature et de l&rsquo;humidit√©.
Mat√©riel Nous allons utiliser :
un Raspberry Pi (ici, la version 3B+) une carte SD de bonne qualit√© (classe 10) une alimentation fournissant du 5 V et du 2.5 √† 3 A un capteur d&rsquo;humidit√© et de temp√©rature DHT22 une r√©sistance de 10 k‚Ñ¶ une breadboard (bloc dans lequel on enfiche les composants √©lectroniques) un autre ordinateur pour se connecter au RPi en SSH un c√¢ble RJ45 Installation du RPi Pr√©paration de la carte SD Il est possible d&rsquo;installer sur un autre ordinateur le logiciel Raspberry Pi Imager qui permet de choisir la bonne version de l&rsquo;OS, la t√©l√©charger et l&rsquo;installer sur la carte SD."></head><body class="ma0 avenir bg-near-white production"><header class="cover bg-top" style=background-image:url(https://blog.deraco.fr/images/2022-08-18-dht22.jpg)><div class="pb3-m pb6-l bg-black-60"><nav class="pv3 ph3 ph4-ns" role=navigation><div class="flex-l justify-between items-center center"><a href=/fr/ class="f3 fw2 hover-white no-underline white-90 dib">Blog de St√©phane</a><div class="flex-l items-center"><h4></h4><ul class="pl0 mr3"><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/en/post/2022-08-18-rpi-dht22/>en</a></li></ul><ul class="pl0 mr3"><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/fr/tags title=Tags>Tags</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/fr/about/ title="√Ä propos page">√Ä propos</a></li></ul><a href=https://twitter.com/stephane_deraco target=_blank class="link-transition twitter link dib z-999 pt3 pt0-l mr1" title="Twitter link" rel=noopener aria-label="follow on Twitter‚Äî‚ÄîOpens in a new window"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href=https://www.linkedin.com/in/st%C3%A9phane-deraco-964640194/ target=_blank class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel=noopener aria-label="follow on LinkedIn‚Äî‚ÄîOpens in a new window"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href=https://github.com/stephane-deraco target=_blank class="link-transition github link dib z-999 pt3 pt0-l mr1" title="Github link" rel=noopener aria-label="follow on Github‚Äî‚ÄîOpens in a new window"><svg height="32" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href=https://blog.deraco.fr/fr/index.xml target=_blank class="link-transition rss link dib z-999 pt3 pt0-l mr1" title="RSS link" rel=noopener aria-label="RSS‚Äî‚ÄîOpens in a new window"><svg xmlns="http://www.w3.org/2000/svg" height="32" width="32" viewBox="0 0 24 24"><circle cx="6.18" cy="17.82" r="2.18"/><path id="scale" d="M4 4.44v2.83c7.03.0 12.73 5.7 12.73 12.73h2.83c0-8.59-6.97-15.56-15.56-15.56zm0 5.66v2.83c3.9.0 7.07 3.17 7.07 7.07h2.83c0-5.47-4.43-9.9-9.9-9.9z"/></svg><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav><div class="tc-l pv6 ph3 ph4-ns"><h1 class="f2 f1-l fw2 white-90 mb0 lh-title">Graphe de temp√©rature et humidit√© avec un Raspberry Pi et un DHT22</h1></div></div></header><main class=pb7 role=main><article class="flex-l flex-wrap justify-between mw10 center ph3"><header class="mt4 w-100"><aside class="instapaper_ignoref b helvetica tracked">POSTS</aside><div id=sharing class=mt3><a href="https://www.facebook.com/sharer.php?u=https://blog.deraco.fr/fr/post/2022-08-18-rpi-dht22/" class="facebook no-underline" aria-label="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></a><a href="https://twitter.com/share?url=https://blog.deraco.fr/fr/post/2022-08-18-rpi-dht22/&text=Graphe%20de%20temp%c3%a9rature%20et%20humidit%c3%a9%20avec%20un%20Raspberry%20Pi%20et%20un%20DHT22" class="twitter no-underline" aria-label="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a><a href="https://www.linkedin.com/shareArticle?mini=true&url=https://blog.deraco.fr/fr/post/2022-08-18-rpi-dht22/&title=Graphe%20de%20temp%c3%a9rature%20et%20humidit%c3%a9%20avec%20un%20Raspberry%20Pi%20et%20un%20DHT22" class="linkedin no-underline" aria-label="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 athelas mt3 mb1">Graphe de temp√©rature et humidit√© avec un Raspberry Pi et un DHT22</h1><time class="f6 mv4 dib tracked" datetime=2022-08-18T00:00:00Z>2022-08-18</time>
<span class="f6 mv4 dib tracked">- 10 minutes de lecture</span>
<span class="f6 mv4 dib tracked">- 1946 mots</span></header><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l"><p>Le DHT22 est un petit capteur de temp√©rature et d&rsquo;humidit√©, facile d&rsquo;utilisation.
On peut utiliser un Raspberry Pi pour interagir avec, et faire des graphes de l&rsquo;√©volution de la temp√©rature et de l&rsquo;humidit√©.</p><h2 id=mat√©riel>Mat√©riel</h2><p>Nous allons utiliser :</p><ul><li>un Raspberry Pi (ici, la version 3B+)</li><li>une carte SD de bonne qualit√© (classe 10)</li><li>une alimentation fournissant du 5 V et du 2.5 √† 3 A</li><li>un capteur d&rsquo;humidit√© et de temp√©rature DHT22</li><li>une r√©sistance de 10 k‚Ñ¶</li><li>une <em>breadboard</em> (bloc dans lequel on enfiche les composants √©lectroniques)</li><li>un autre ordinateur pour se connecter au RPi en SSH</li><li>un c√¢ble RJ45</li></ul><h2 id=installation-du-rpi>Installation du RPi</h2><h3 id=pr√©paration-de-la-carte-sd>Pr√©paration de la carte SD</h3><p>Il est possible d&rsquo;installer sur un autre ordinateur le logiciel <em><a href=https://www.raspberrypi.com/software/>Raspberry Pi Imager</a></em> qui permet de choisir la bonne version de l&rsquo;OS, la t√©l√©charger et l&rsquo;installer sur la carte SD.
C&rsquo;est la solution la plus simple.</p><p>Si on ne souhaite pas installer ce logiciel, alors on peut r√©cup√©rer l&rsquo;image correspondante √† la bonne version du Raspberry Pi ici : <a href=https://www.raspberrypi.com/software/operating-systems/>https://www.raspberrypi.com/software/operating-systems/</a>.
Dans ce cas, il faut ensuite extraire l&rsquo;image, puis la flasher sur la carte SD avec un outil graphique tel que <a href=https://www.balena.io/etcher/>Etcher</a> ou en ligne de commande pour les plus exp√©riment√©s.</p><p>Une fois l&rsquo;OS install√© sur la carte SD, nous allons cr√©er deux fichiers sp√©ciaux dans la partition <code>boot</code> :</p><ul><li>un fichier vide <code>ssh</code>, pour activer le serveur SSH</li><li>un fichier <code>userconf</code> contenant le mot de passe de l&rsquo;utilisateur <code>pi</code> (en effet, <a href=https://www.raspberrypi.com/news/raspberry-pi-bullseye-update-april-2022/>il n&rsquo;y a plus de mot de passe par d√©faut</a>)</li></ul><p>Le contenu du fichier <code>userconf</code> doit contenir le nouveau mot de passe hash√© de l&rsquo;utilisateur <code>pi</code>.
Le fichier peut √™tre cr√©√© de cette fa√ßon :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># Se placer dans la partition boot, √† adapter en fonction de votre OS</span>
</span></span><span style=display:flex><span>cd /Volumes/boot
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Cr√©er le fichier</span>
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>echo -n <span style=color:#e6db74>&#39;pi:&#39;</span>; echo <span style=color:#e6db74>&#39;changeme&#39;</span> | openssl passwd -6 -stdin<span style=color:#f92672>)</span> &gt; userconf
</span></span></code></pre></div><p>On peut alors ins√©rer la carte SD dans le RPi, brancher le c√¢ble RJ45 entre le RPi et la box internet (ou le routeur) et le d√©marrer en le branchant au secteur.</p><h3 id=premier-d√©marrage-du-rpi>Premier d√©marrage du RPi</h3><p>Le RPi d√©marre, et comme il est connect√© √† la box internet (ou au routeur) par le c√¢ble RJ45, il acquiert une adresse IP automatiquement.</p><blockquote><p><strong>Note</strong> : Le fait que le RPi r√©cup√®re automatiquement une adresse IP est gr√¢ce au protocole DHCP qui normalement est en place sur la plupart des box internet.</p></blockquote><p>On ne connait pas son adresse IP pour le moment, mais on peut la r√©cup√©rer d&rsquo;au moins deux fa√ßons.</p><ul><li><p><strong><em>Via</em> l&rsquo;interface de configuration de la box internet</strong><br>Par exemple, avec une Freebox, aller sur <a href=http://mafreebox.freebox.fr/>http://mafreebox.freebox.fr/</a>, puis <em>P√©riph√©riques r√©seau</em>, clic-droit sur &ldquo;raspberry pi&rdquo; > <em>Propri√©t√©s</em> puis onglet <em>Connectivit√©</em>.
On voit alors la derni√®re adresse IP.
On peut √©galement obtenir cette information en allant dans les param√®tres DHCP de la Freebox et visualiser les baux actifs.</p></li><li><p><strong>Avec <code>nmap</code></strong><br>Il faut d&rsquo;abord identifier sur quel r√©seau se trouve l&rsquo;ordinateur √† partir duquel on va scanner les appareils.
Pour cela, r√©cup√©rer l&rsquo;adresse IP de l&rsquo;ordinateur :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># Windows : Panneau de contr√¥le &gt; Centre r√©seau et partage, ou ouvrir une console et taper :</span>
</span></span><span style=display:flex><span>ipconfig
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Linux</span>
</span></span><span style=display:flex><span>hostname -I
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Mac : Pr√©f√©rences Syst√®me &gt; R√©seau</span>
</span></span></code></pre></div><p>Si l&rsquo;adresse est de type 192.168.0.78, alors taper la commande suivante (voir <a href=https://nmap.org/download>cette page</a> pour installer nmap) :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo nmap -sP 192.168.0.0/24
</span></span></code></pre></div><p>Le r√©sultat est similaire √† :</p><pre tabindex=0><code>Starting Nmap 7.92 ( https://nmap.org ) at 2022-07-29 18:02 CEST
Nmap scan report for 192.168.0.20
Host is up (0.19s latency).
MAC Address: E8:A0:CD:B8:14:8D (Nintendo)
[...]
Nmap scan report for 192.168.0.67
Host is up (0.19s latency).
MAC Address: B8:27:EB:C8:C4:EE (Raspberry Pi Foundation)
Nmap scan report for 192.168.0.254
Host is up (0.074s latency).
MAC Address: 14:0C:76:A5:00:8E (Freebox SAS)
Nmap scan report for 192.168.0.55
Host is up.
Nmap done: 256 IP addresses (8 hosts up) scanned in 7.22 seconds
</code></pre><p>On trouve alors l&rsquo;adresse IP du RPi, ici 192.168.0.67.</p></li></ul><h3 id=connexion-en-ssh-au-rpi>Connexion en SSH au RPi</h3><p>Maintenant que l&rsquo;on connait son adresse IP, on peut s&rsquo;y connecter en SSH (r√©pondre <code>yes</code> √† la question <em>&ldquo;Are you sure you want to continue connecting&rdquo;</em> qui ne sera pos√©e qu&rsquo;√† la premi√®re connexion) :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>‚ùØ ssh pi@192.168.0.67
</span></span><span style=display:flex><span>The authenticity of host <span style=color:#e6db74>&#39;192.168.0.67 (192.168.0.67)&#39;</span> can<span style=color:#e6db74>&#39;t be established.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>ED25519 key fingerprint is SHA256:wL5gzndcDXNkA/Zh8RexfyvFWlyhFYQw2PMvVHhyq20.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>This key is not known by any other names
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Warning: Permanently added &#39;</span>192.168.0.67<span style=color:#e6db74>&#39; (ED25519) to the list of known hosts.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>pi@192.168.0.67&#39;</span>s password: 
</span></span><span style=display:flex><span>Linux raspberrypi 5.15.32-v8+ <span style=color:#75715e>#1538 SMP PREEMPT Thu Mar 31 19:40:39 BST 2022 aarch64</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>The programs included with the Debian GNU/Linux system are free software;
</span></span><span style=display:flex><span>the exact distribution terms <span style=color:#66d9ef>for</span> each program are described in the
</span></span><span style=display:flex><span>individual files in /usr/share/doc/*/copyright.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
</span></span><span style=display:flex><span>permitted by applicable law.
</span></span><span style=display:flex><span>Last login: Fri Jul <span style=color:#ae81ff>29</span> 17:07:46 <span style=color:#ae81ff>2022</span> from 192.168.0.67
</span></span><span style=display:flex><span>pi@raspberrypi:~ $ 
</span></span></code></pre></div><p>On est alors connect√© sur le RPi.</p><h3 id=mise-√†-jour-et-configuration-wi-fi>Mise √† jour et configuration Wi-Fi</h3><p>Une fois connect√©, lancer la mise √† jour :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo apt update
</span></span><span style=display:flex><span>sudo apt upgrade
</span></span></code></pre></div><p>La configuration du Wi-Fi est optionnelle, mais permettra de se passer du c√¢ble RJ45, et donc de mettre le RPi o√π l&rsquo;on veut.
On utilise l&rsquo;outil <code>raspi-config</code> :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo raspi-config
</span></span></code></pre></div><p>Puis aller dans :</p><ul><li><code>5 Localisation Options</code></li><li><code>L4 WLAN Country</code></li><li>S√©lectionner le pays, par exemple <code>FR France</code></li><li><code>Ok</code></li><li><code>1 System Options</code></li><li><code>S1 Wireless LAN</code></li><li>Renseigner le SSID (le <em>nom</em>) du r√©seau Wi-Fi</li><li>Renseigner le mot de passe (attendre un peu apr√®s avoir valid√©)</li><li><em>Tabulation</em> > <code>Finish</code></li><li>√Ä la question <code>Would you like to reboot now?</code>, s√©lectionner <code>No</code></li></ul><p>Pour v√©rifier que le r√©seau Wi-Fi est bien configur√©, taper :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ip a
</span></span></code></pre></div><p>Rechercher alors le bloc correspondant √† <code>wlan0</code> :</p><pre tabindex=0><code>3: wlan0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether b8:27:eb:9d:91:bb brd ff:ff:ff:ff:ff:ff
    inet 192.168.0.54/24 brd 192.168.0.255 scope global dynamic noprefixroute wlan0
       valid_lft 43103sec preferred_lft 37703sec
    inet6 2a01:e0a:b15:4890:29a:d0ce:e2aa:4179/64 scope global dynamic mngtmpaddr noprefixroute 
       valid_lft 86303sec preferred_lft 86303sec
    inet6 fe80::ab3e:f91d:ea52:4912/64 scope link 
       valid_lft forever preferred_lft forever
</code></pre><p>On y retrouve alors l&rsquo;adresse IP de la carte Wi-Fi du RPi, ici 192.168.0.54.</p><p>On peut alors √©teindre le RPi (<code>sudo halt</code>), d√©brancher le c√¢ble RJ45, puis le red√©marrer en enlevant et remettant l&rsquo;alimentation.</p><p>Si tout se passe bien, la connexion SSH sur cette nouvelle adresse IP devrait fonctionner.
Comme c&rsquo;est la premi√®re connexion sur cette adresse, on aura la m√™me question <em>&ldquo;Are you sure you want to continue connecting&rdquo;</em>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ssh pi@192.168.0.54
</span></span></code></pre></div><h2 id=communiquer-avec-le-capteur>Communiquer avec le capteur</h2><p>Le capteur sera reli√© au RPi √† travers ses broches GPIO.
Pour r√©cup√©rer ses valeurs, nous allons √©crire un programme en Python.
Nous allons √©galement utiliser une biblioth√®que qui nous facilitera la communication avec le capteur.</p><h3 id=ajout-de-logiciels>Ajout de logiciels</h3><p>Python est d√©j√† install√© par d√©faut sur le RPi, nous allons simplement installer la biblioth√®que <a href=https://github.com/adafruit/Adafruit_CircuitPython_DHT>Adafruit CircuitPython DHT</a> qui communiquera avec le capteur.
Pour cela, se connecter en SSH au RPi, et taper les commandes suivantes :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># Installation des d√©pendances</span>
</span></span><span style=display:flex><span>sudo apt -y install python3-pip python3-venv libgpiod2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># On va utiliser un r√©pertoire d√©di√©</span>
</span></span><span style=display:flex><span>mkdir dht22
</span></span><span style=display:flex><span>cd dht22
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Cr√©ation d&#39;un environnement virtuel Python</span>
</span></span><span style=display:flex><span>python -m venv .venv
</span></span><span style=display:flex><span>source .venv/bin/activate
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Installation de la biblioth√®que &#34;Adafruit CircuitPython DHT&#34; pour communiquer avec le capteur</span>
</span></span><span style=display:flex><span>pip install adafruit-circuitpython-dht
</span></span></code></pre></div><h3 id=branchements>Branchements</h3><p>Le capteur DHT22 a 4 broches, qui correspondent √† :</p><table><thead><tr><th>PIN</th><th>Description</th></tr></thead><tbody><tr><td>1</td><td>VCC (3.3V √† 6V)</td></tr><tr><td>2</td><td>Donn√©es</td></tr><tr><td>3</td><td>Non utilis√©</td></tr><tr><td>4</td><td>Terre</td></tr></tbody></table><p>De plus, il faut une r√©sistance de 10 ohms entre les broches 1 (VCC) et 2 (Donn√©es).</p><p>On peut retrouver ces informations <a href=https://learn.adafruit.com/dht/connecting-to-a-dhtxx-sensor>sur le site Adafruit</a> ou encore <a href=https://www.sparkfun.com/datasheets/Sensors/Temperature/DHT22.pdf>dans les specifications techniques du capteur</a>.</p><p>Sur le RPi 3B+, la disposition des broches GPIO est la suivante (<a href=https://datasheets.raspberrypi.com/rpi3/raspberry-pi-3-b-plus-reduced-schematics.pdf>source</a>) :</p><p><img src=images/rpi-gpio.png alt="RPi GPIO"></p><p>On va donc utiliser :</p><ul><li>broche 1 (3V3) pour le courant</li><li>broche 7 (GPIO4) pour recevoir les donn√©es</li><li>broche 9 (GND) pour la terre</li></ul><p>La connexion du capteur sur le Raspberry Pi se fait de cette fa√ßon :</p><p><img src=images/circuit-breadboard.png alt="Platine d&amp;rsquo;essai"></p><p>Montage r√©el :</p><p><img src=images/real-circuit.jpeg alt="Montage r√©el"></p><h3 id=premier-test>Premier test</h3><p>On va v√©rifier que le montage est correct en utilisant le shell interactif de python.
Dans le r√©pertoire que l&rsquo;on a cr√©√© (<code>dht22</code>), s&rsquo;assurer que l&rsquo;on a bien activ√© l&rsquo;environnement d√©di√© (<code>source .venv/bin/activate</code>) puis lancer Python et taper les commandes suivantes :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> adafruit_dht
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> board
</span></span><span style=display:flex><span>dht <span style=color:#f92672>=</span> adafruit_dht<span style=color:#f92672>.</span>DHT22(board<span style=color:#f92672>.</span>D4)
</span></span><span style=display:flex><span>dht<span style=color:#f92672>.</span>humidity
</span></span><span style=display:flex><span>dht<span style=color:#f92672>.</span>temperature
</span></span></code></pre></div><p>On a alors une sortie similaire √† :</p><pre tabindex=0><code>(.venv) pi@raspberrypi:~/dht22 $ python
Python 3.9.2 (default, Feb 28 2021, 17:03:44) 
[GCC 10.2.1 20210110] on linux
Type &#34;help&#34;, &#34;copyright&#34;, &#34;credits&#34; or &#34;license&#34; for more information.
&gt;&gt;&gt; import adafruit_dht
&gt;&gt;&gt; import board
&gt;&gt;&gt; dht = adafruit_dht.DHT22(board.D4)
&gt;&gt;&gt; dht.humidity
55.1
&gt;&gt;&gt; dht.temperature
28.0
&gt;&gt;&gt; 
</code></pre><p>Le circuit fonctionne comme attendu.</p><h2 id=r√©cup√©ration-et-stockage-des-valeurs>R√©cup√©ration et stockage des valeurs</h2><p>Pour stocker les valeurs et permettre leur r√©cup√©ration pour faire des graphes, on va utiliser une base de donn√©es temporelles.
Il en existe plusieurs, ici on va utiliser <a href=https://prometheus.io>Prometheus</a>.</p><p>Prometheus fonctionne en mode <em>pull</em>, c&rsquo;est lui qui r√©cup√®re les m√©triques.
Il faut que l&rsquo;on fasse un script Python qui retourne les donn√©es du capteur en tant que r√©ponse √† une requ√™te HTTP issue du collecteur de Prometheus.</p><h3 id=script-de-collecte>Script de collecte</h3><p>On installe le <a href=https://github.com/prometheus/client_python>client Prometheus pour Python</a> :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>pip install prometheus-client
</span></span></code></pre></div><p>Le script suivant d√©marre un serveur web qui sera interrog√© par Prometheus et exposera les m√©triques r√©colt√©es :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e>#!/home/pi/dht22/.venv/bin/python</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> adafruit_dht
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> board
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> time
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> prometheus_client <span style=color:#f92672>import</span> start_http_server, Gauge
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>DATA_PIN <span style=color:#f92672>=</span> board<span style=color:#f92672>.</span>D4
</span></span><span style=display:flex><span>DELAY <span style=color:#f92672>=</span> <span style=color:#ae81ff>60</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>dht <span style=color:#f92672>=</span> adafruit_dht<span style=color:#f92672>.</span>DHT22(DATA_PIN)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>temperature_gauge <span style=color:#f92672>=</span> Gauge(<span style=color:#e6db74>&#39;dht22_temperature&#39;</span>, <span style=color:#e6db74>&#39;Temp√©rature ambiante en degr√©s Celsius&#39;</span>)
</span></span><span style=display:flex><span>humidity_gauge <span style=color:#f92672>=</span> Gauge(<span style=color:#e6db74>&#39;dht22_humidity&#39;</span>, <span style=color:#e6db74>&#39;Humidit√© ambiante en %&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>start_http_server(<span style=color:#ae81ff>8000</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        temperature <span style=color:#f92672>=</span> dht<span style=color:#f92672>.</span>temperature
</span></span><span style=display:flex><span>        humidity <span style=color:#f92672>=</span> dht<span style=color:#f92672>.</span>humidity
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> humidity <span style=color:#f92672>is</span> <span style=color:#f92672>not</span> <span style=color:#66d9ef>None</span> <span style=color:#f92672>and</span> temperature <span style=color:#f92672>is</span> <span style=color:#f92672>not</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>            temperature_gauge<span style=color:#f92672>.</span>set(temperature)
</span></span><span style=display:flex><span>            humidity_gauge<span style=color:#f92672>.</span>set(humidity)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>RuntimeError</span>:
</span></span><span style=display:flex><span>        <span style=color:#75715e># If error, do nothing, just wait for the next</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    time<span style=color:#f92672>.</span>sleep(DELAY)
</span></span></code></pre></div><p>Pour rendre ce script ex√©cutable :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>chmod +x sensors.py
</span></span></code></pre></div><p>On peut le tester en le lan√ßant avec <code>./sensors.py</code>, et en allant sur la page <a href=http://192.168.0.54:8000>http://192.168.0.54:8000</a> (adapter l&rsquo;adresse IP avec celle du RPi).</p><p>Pour g√©rer ce script avec <em>systemd</em> et qu&rsquo;il soit automatiquement lanc√© au d√©marrage, cr√©er le fichier suivant :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo vim /etc/systemd/system/dht22.service
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-systemd data-lang=systemd><span style=display:flex><span><span style=color:#75715e># /etc/systemd/system/dht22.service</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[Unit]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Description</span><span style=color:#f92672>=</span><span style=color:#e6db74>Temperature and humidity sensor</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>After</span><span style=color:#f92672>=</span><span style=color:#e6db74>network.target</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[Service]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Type</span><span style=color:#f92672>=</span><span style=color:#e6db74>simple</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Restart</span><span style=color:#f92672>=</span><span style=color:#e6db74>always</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStart</span><span style=color:#f92672>=</span><span style=color:#e6db74>/home/pi/dht22/.venv/bin/python /home/pi/dht22/sensors.py</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[Install]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>WantedBy</span><span style=color:#f92672>=</span><span style=color:#e6db74>multi-user.target</span>
</span></span></code></pre></div><p>Puis lancer les commandes suivantes :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo systemctl enable dht22.service
</span></span><span style=display:flex><span>sudo systemctl start dht22.service
</span></span></code></pre></div><h3 id=prometheus>Prometheus</h3><p>L&rsquo;installation se fait simplement avec :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo apt install prometheus
</span></span></code></pre></div><p>On peut v√©rifier qu&rsquo;il est bien d√©marr√© avec :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>systemctl status prometheus
</span></span></code></pre></div><p>et aussi en allant sur la page <a href=http://192.168.0.54:9090>http://192.168.0.54:9090</a>.</p><p>On va ajouter notre configuration de collecte des m√©triques √† la fin du fichier de configuration :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo vim /etc/prometheus/prometheus.yml
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>  - <span style=color:#f92672>job_name</span>: <span style=color:#ae81ff>dht22</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>scrape_interval</span>: <span style=color:#ae81ff>1m</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>static_configs</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>targets</span>: [<span style=color:#e6db74>&#39;localhost:8000&#39;</span>]
</span></span></code></pre></div><blockquote><p><strong>Note</strong> : Attention √† bien respecter l&rsquo;indentation, ce bloc doit √™tre sous le bloc <code>scrape_configs</code>.</p></blockquote><p>On red√©marre Prometheus pour prendre en compte ces modifications :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo systemctl restart prometheus
</span></span></code></pre></div><p>En allant sur la page de Prometheus <a href=http://192.168.0.54:9090>http://192.168.0.54:9090</a>, on devrait normalement trouver nos deux m√©triques :</p><p><img src=images/prometheus_gui_measures.png alt="Mesures dans Prometheus GUI"></p><h2 id=affichage-des-valeurs>Affichage des valeurs</h2><p>On va utiliser <a href=https://grafana.com/grafana/>Grafana</a> comme interface pour suivre l&rsquo;√©volution des mesures.</p><h3 id=mise-en-place-de-grafana>Mise en place de Grafana</h3><p>Grafana n&rsquo;est pas dans les paquets de RaspberryPi OS, on va donc suivre l&rsquo;installation pr√©conis√©e :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo apt -y install adduser libfontconfig1
</span></span><span style=display:flex><span>wget https://dl.grafana.com/oss/release/grafana_9.0.5_arm64.deb
</span></span><span style=display:flex><span>sudo dpkg -i grafana_9.0.5_arm64.deb
</span></span><span style=display:flex><span>rm grafana_9.0.5_arm64.deb
</span></span><span style=display:flex><span>sudo systemctl daemon-reload
</span></span><span style=display:flex><span>sudo systemctl enable grafana-server
</span></span><span style=display:flex><span>sudo systemctl start grafana-server
</span></span></code></pre></div><p>Tester que Grafana est disponible en allant sur <a href=http://192.168.0.54:3000>http://192.168.0.54:3000</a>.</p><p>Utiliser <code>admin</code> en nom d&rsquo;utilisateur et en mot de passe pour la premi√®re connexion et suivre les instructions pour modifier le mot de passe par d√©faut.</p><h3 id=param√©trage-de-grafana>Param√©trage de Grafana</h3><p>Cliquer sur le bouton <em>Add your first data source</em> (ou aller dans <em>Configuration</em> > <em>Data sources</em>).</p><p>S√©lectionner <em>Prometheus</em>, mettre <code>http://localhost:9090</code> dans le champ URL, puis cliquer sur <em>Save & Test</em>.
Normalement, le test devrait √™tre concluant.</p><p>Enfin, retourner, √† l&rsquo;accueil et cliquer sur <em>Dashboard</em> > <em>Import</em>, et utiliser <a href=data/dashboard.json>ce fichier</a> pour un exemple de dashboard.</p><p><img src=images/grafana.png alt="Dashboard Grafana"></p><p>On peut voir que le capteur d&rsquo;humidit√© n&rsquo;est pas parfait :)
Il a des pics r√©guliers, et on n&rsquo;a pas eu 90% d&rsquo;humidit√© le 8 mai üò±.</p><ul class=pa0><li class=list><a href=/fr/tags/raspberry-pi class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Raspberry Pi</a></li><li class=list><a href=/fr/tags/dht22 class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">DHT22</a></li><li class=list><a href=/fr/tags/humidit%C3%A9 class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Humidit√©</a></li><li class=list><a href=/fr/tags/temp%C3%A9rature class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Temp√©rature</a></li><li class=list><a href=/fr/tags/grafana class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Grafana</a></li><li class=list><a href=/fr/tags/prometheus class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Prometheus</a></li></ul><div class="mt6 instapaper_ignoref"></div></div><aside class="w-30-l mt6-l"><div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links"><p class="f5 b mb3">Table des mati√®res</p><nav id=TableOfContents><ul><li><a href=#mat√©riel>Mat√©riel</a></li><li><a href=#installation-du-rpi>Installation du RPi</a><ul><li><a href=#pr√©paration-de-la-carte-sd>Pr√©paration de la carte SD</a></li><li><a href=#premier-d√©marrage-du-rpi>Premier d√©marrage du RPi</a></li><li><a href=#connexion-en-ssh-au-rpi>Connexion en SSH au RPi</a></li><li><a href=#mise-√†-jour-et-configuration-wi-fi>Mise √† jour et configuration Wi-Fi</a></li></ul></li><li><a href=#communiquer-avec-le-capteur>Communiquer avec le capteur</a><ul><li><a href=#ajout-de-logiciels>Ajout de logiciels</a></li><li><a href=#branchements>Branchements</a></li><li><a href=#premier-test>Premier test</a></li></ul></li><li><a href=#r√©cup√©ration-et-stockage-des-valeurs>R√©cup√©ration et stockage des valeurs</a><ul><li><a href=#script-de-collecte>Script de collecte</a></li><li><a href=#prometheus>Prometheus</a></li></ul></li><li><a href=#affichage-des-valeurs>Affichage des valeurs</a><ul><li><a href=#mise-en-place-de-grafana>Mise en place de Grafana</a></li><li><a href=#param√©trage-de-grafana>Param√©trage de Grafana</a></li></ul></li></ul></nav></div></aside></article></main><footer class="bg-dark-gray bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://blog.deraco.fr/>&copy; Blog de St√©phane
2021-2022</a><div><a class="f8 fw4 hover-white no-underline white-40 dn dib-ns pv2 ph3" rel=license href=http://creativecommons.org/licenses/by-nc-sa/4.0/>Contenu sous licence : <img alt="Creative Commons License" style=border-width:0 src=https://i.creativecommons.org/l/by-nc-sa/4.0/80x15.png></a>
<a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=/fr/credits>Cr√©dits</a>
<a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=/fr/terms>Mentions l√©gales</a></div><div><a href=https://twitter.com/stephane_deraco target=_blank class="link-transition twitter link dib z-999 pt3 pt0-l mr1" title="Twitter link" rel=noopener aria-label="follow on Twitter‚Äî‚ÄîOpens in a new window"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href=https://www.linkedin.com/in/st%C3%A9phane-deraco-964640194/ target=_blank class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel=noopener aria-label="follow on LinkedIn‚Äî‚ÄîOpens in a new window"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href=https://github.com/stephane-deraco target=_blank class="link-transition github link dib z-999 pt3 pt0-l mr1" title="Github link" rel=noopener aria-label="follow on Github‚Äî‚ÄîOpens in a new window"><svg height="32" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href=https://blog.deraco.fr/fr/index.xml target=_blank class="link-transition rss link dib z-999 pt3 pt0-l mr1" title="RSS link" rel=noopener aria-label="RSS‚Äî‚ÄîOpens in a new window"><svg xmlns="http://www.w3.org/2000/svg" height="32" width="32" viewBox="0 0 24 24"><circle cx="6.18" cy="17.82" r="2.18"/><path id="scale" d="M4 4.44v2.83c7.03.0 12.73 5.7 12.73 12.73h2.83c0-8.59-6.97-15.56-15.56-15.56zm0 5.66v2.83c3.9.0 7.07 3.17 7.07 7.07h2.83c0-5.47-4.43-9.9-9.9-9.9z"/></svg><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></footer></body></html>